version: "3.9"

services:
  k3s:
    image: rancher/k3s:v1.28.5-k3s1
    container_name: k8s-eni-tagger-k3s
    hostname: k3s
    command:
      - server
      - --disable=traefik
      - --disable=servicelb
      - --disable=metrics-server
      - --disable=local-storage
      - --write-kubeconfig-mode=644
    privileged: true
    environment:
      - K3S_TOKEN=k8s-eni-tagger-test
      - K3S_KUBECONFIG_OUTPUT=/output/kubeconfig.yaml
    volumes:
      - k3s-data:/var/lib/rancher/k3s
      - kubeconfig:/output
    ports:
      - "6443:6443"
    healthcheck:
      test: ["CMD", "kubectl", "get", "--raw", "/readyz"]
      interval: 5s
      timeout: 3s
      retries: 30
    networks:
      - e2e-v2

  kubeconfig-fixer:
    image: alpine:3.19
    depends_on:
      k3s:
        condition: service_healthy
    volumes:
      - kubeconfig:/kubeconfig
    command: >
      sh -c "sleep 2 && sed -i 's|https://127\\.0\\.0\\.1:6443|https://k3s:6443|g' /kubeconfig/kubeconfig.yaml && echo 'Kubeconfig fixed: 127.0.0.1:6443 â†’ k3s:6443'"
    networks:
      - e2e-v2

  aws-mock:
    build:
      context: ../mock
      dockerfile: Dockerfile
    container_name: k8s-eni-tagger-aws-mock
    hostname: aws-mock
    ports:
      - "4566:4566"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/healthz"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - e2e-v2

  runner:
    build:
      context: ../runner
      dockerfile: Dockerfile
    container_name: k8s-eni-tagger-runner
    hostname: runner
    depends_on:
      k3s:
        condition: service_healthy
      aws-mock:
        condition: service_healthy
      kubeconfig-fixer:
        condition: service_completed_successfully
    environment:
      - KUBECONFIG=/kubeconfig/kubeconfig.yaml
      - AWS_REGION=us-west-2
      - AWS_ACCESS_KEY_ID=testing
      - AWS_SECRET_ACCESS_KEY=testing
      - AWS_MOCK_URL=http://aws-mock:4566
      - CONTROLLER_IMAGE=k8s-eni-tagger:dev
      - CONTROLLER_NAMESPACE=default
      - TEST_POD_IP=10.0.1.42
    volumes:
      - kubeconfig:/kubeconfig
      - ../manifests:/manifests:ro
      - ../runner:/runner:ro
      - ../../:/workspace:ro
      - /var/run/docker.sock:/var/run/docker.sock
    command: ["/runner/run.sh"]
    networks:
      - e2e-v2

volumes:
  k3s-data:
  kubeconfig:

networks:
  e2e-v2:
    driver: bridge
